// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  internal_id     Int     @id @default(autoincrement())
  id              String  @unique @default(dbgenerated("ulid_generate()"))
  name            String
  email           String?
  contact_number  String?
  address         String?
  logo            String?
  website         String?
  description     String?
  status          String   @default("ACTIVE")
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  users                   User[]
  employees               Employee[]
  admins                  Admin[]
  departments             Department[]
  jobTitles               JobTitle[]
  benefits                Benefit[]
  documents               Document[]
  permissions             Permission[]
  roles                   Role[]
  auditLogs               AuditLog[]
  organizationOnboarding  OrganizationOnboarding[]
  organizationOffboarding OrganizationOffboarding[]
  HolidayTemplate         HolidayTemplate[]
  Calendar                Calendar[]

  @@map("organizations")
}

model Department {
  internal_id     Int     @id @default(autoincrement())
  id              String  @unique @default(dbgenerated("ulid_generate()"))
  organization_id Int
  name            String
  description     String?

  organization Organization @relation(fields: [organization_id], references: [internal_id], onDelete: Cascade)
  employees    Employee[]

  @@map("departments")
}

model JobTitle {
  internal_id     Int     @id @default(autoincrement())
  id              String  @unique @default(dbgenerated("ulid_generate()"))
  organization_id Int
  name            String
  description     String?

  organization Organization @relation(fields: [organization_id], references: [internal_id], onDelete: Cascade)
  employees    Employee[]

  @@map("job_titles")
}

model User {
  internal_id     Int     @id @default(autoincrement())
  id              String  @unique @default(dbgenerated("ulid_generate()"))
  name            String?
  email           String    @unique
  emailVerified   DateTime?
  image           String?
  password_hash   String?   @db.Text
  status          String    @default("ACTIVE")
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  organization_id Int

  // Relations
  organization Organization @relation(fields: [organization_id], references: [internal_id], onDelete: Cascade)
  employee     Employee?
  userRoles    UserRole[]
  auditLogs    AuditLog[]

  // Better Auth relations
  accounts Account[]
  sessions Session[]

  @@map("users")
}

model Employee {
  internal_id       Int     @id @default(autoincrement())
  id                String  @unique @default(dbgenerated("ulid_generate()"))
  organization_id   Int
  user_id           String?  @unique
  department_id     Int
  job_title_id      Int
  manager_id        String?
  first_name        String
  last_name         String
  email             String
  // Work details
  work_email        String?
  work_contact      String?
  // Personal details
  personal_address        String
  personal_contact_number String
  personal_email          String?
  date_of_birth           DateTime
  gender                  String
  employment_status String    @default("ACTIVE")
  hire_date         DateTime
  exit_date         DateTime?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  organization               Organization                @relation(fields: [organization_id], references: [internal_id], onDelete: Cascade)
  user                       User?                       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  department                 Department                  @relation(fields: [department_id], references: [internal_id])
  jobTitle                   JobTitle                    @relation(fields: [job_title_id], references: [internal_id])
  manager                    Employee?                   @relation("EmployeeReportsTo", fields: [manager_id], references: [id])
  directReports              Employee[]                  @relation("EmployeeReportsTo")
  compensations              Compensation[]
  employeeBenefits           EmployeeBenefit[]
  employeeDocuments          EmployeeDocument[]
  timesheets                 Timesheet[]
  leaveRequests              LeaveRequest[]
  payrolls                   Payroll[]
  employeeOnboarding         EmployeeOnboarding?
  employeeOffboarding        EmployeeOffboarding?
  employeeHolidayAssignments EmployeeHolidayAssignment[]
  auditLogs                  AuditLog[]

  @@map("employees")
}

model Compensation {
  internal_id    Int     @id @default(autoincrement())
  id             String  @unique @default(dbgenerated("ulid_generate()"))
  employee_id    String
  base_salary    Float
  pay_frequency  String
  effective_date DateTime
  created_at     DateTime @default(now())

  employee Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@map("compensations")
}

model Benefit {
  internal_id     Int     @id @default(autoincrement())
  id              String  @unique @default(dbgenerated("ulid_generate()"))
  organization_id Int
  name            String
  description     String?
  type            String

  organization     Organization      @relation(fields: [organization_id], references: [internal_id], onDelete: Cascade)
  employeeBenefits EmployeeBenefit[]

  @@map("benefits")
}

model EmployeeBenefit {
  internal_id           Int     @id @default(autoincrement())
  id                    String  @unique @default(dbgenerated("ulid_generate()"))
  employee_id           String
  benefit_id            String
  employee_contribution Float
  enrollment_date       DateTime @default(now())

  employee Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  benefit  Benefit  @relation(fields: [benefit_id], references: [id], onDelete: Cascade)

  @@map("employee_benefits")
}

model Document {
  internal_id        Int     @id @default(autoincrement())
  id                 String  @unique @default(dbgenerated("ulid_generate()"))
  organization_id    Int
  name               String
  file_type          String
  storage_path       String
  requires_signature Boolean  @default(false)

  organization      Organization       @relation(fields: [organization_id], references: [internal_id], onDelete: Cascade)
  employeeDocuments EmployeeDocument[]

  @@map("documents")
}

model EmployeeDocument {
  internal_id Int     @id @default(autoincrement())
  id          String  @unique @default(dbgenerated("ulid_generate()"))
  employee_id String
  document_id String
  version     String
  uploaded_at DateTime  @default(now())
  signed_at   DateTime?

  employee Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  document Document @relation(fields: [document_id], references: [id], onDelete: Cascade)

  @@map("employee_documents")
}

model AuditLog {
  internal_id     Int     @id @default(autoincrement())
  id              String  @unique @default(dbgenerated("ulid_generate()"))
  organization_id Int
  user_id         String
  action_type     String
  entity_type     String
  entity_id       String?
  old_data        Json?
  new_data        Json?
  timestamp       DateTime @default(now())

  organization Organization @relation(fields: [organization_id], references: [internal_id], onDelete: Cascade)
  user         User         @relation(fields: [user_id], references: [id])
  employee     Employee?    @relation(fields: [entity_id], references: [id])

  @@map("audit_logs")
}

model Role {
  internal_id     Int     @id @default(autoincrement())
  id              String  @unique @default(dbgenerated("ulid_generate()"))
  organization_id Int
  name            String   @unique
  description     String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  organization    Organization     @relation(fields: [organization_id], references: [internal_id], onDelete: Cascade)
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Permission {
  internal_id     Int     @id @default(autoincrement())
  id              String  @unique @default(dbgenerated("ulid_generate()"))
  name            String   @unique
  description     String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  rolePermissions RolePermission[]
  Organization    Organization?    @relation(fields: [organization_id], references: [internal_id])
  organization_id Int?

  @@map("permissions")
}

model UserRole {
  internal_id Int     @id @default(autoincrement())
  id          String  @unique @default(dbgenerated("ulid_generate()"))
  user_id     String
  role_id     String
  created_at  DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role Role @relation(fields: [role_id], references: [id], onDelete: Cascade)

  @@unique([user_id, role_id])
  @@map("user_roles")
}

model RolePermission {
  internal_id   Int     @id @default(autoincrement())
  id            String  @unique @default(dbgenerated("ulid_generate()"))
  role_id       String
  permission_id String
  created_at    DateTime @default(now())

  role       Role       @relation(fields: [role_id], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  @@unique([role_id, permission_id])
  @@map("role_permissions")
}

model Admin {
  internal_id     Int     @id @default(autoincrement())
  id              String  @unique @default(dbgenerated("ulid_generate()"))
  organization_id Int
  name            String
  email           String
  role            String
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  organization Organization @relation(fields: [organization_id], references: [internal_id], onDelete: Cascade)

  @@map("admins")
}

model EmployeeOnboarding {
  internal_id    Int     @id @default(autoincrement())
  id             String  @unique @default(dbgenerated("ulid_generate()"))
  employee_id    String   @unique
  date_started   DateTime  @default(now())
  date_completed DateTime?
  status         String    @default("PENDING")
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  employee Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@map("employee_onboarding")
}

model EmployeeOffboarding {
  internal_id    Int     @id @default(autoincrement())
  id             String  @unique @default(dbgenerated("ulid_generate()"))
  employee_id    String   @unique
  date_started   DateTime  @default(now())
  date_completed DateTime?
  reason         String?
  status         String    @default("PENDING")
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  employee Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@map("employee_offboarding")
}

model OrganizationOnboarding {
  internal_id     Int     @id @default(autoincrement())
  id              String  @unique @default(dbgenerated("ulid_generate()"))
  organization_id Int   @unique
  started_at      DateTime  @default(now())
  completed_at    DateTime?
  status          String    @default("PENDING")
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  organization Organization @relation(fields: [organization_id], references: [internal_id], onDelete: Cascade)

  @@map("organization_onboarding")
}

model OrganizationOffboarding {
  internal_id     Int     @id @default(autoincrement())
  id              String  @unique @default(dbgenerated("ulid_generate()"))
  organization_id Int   @unique
  started_at      DateTime  @default(now())
  completed_at    DateTime?
  reason          String?
  status          String    @default("PENDING")
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  organization Organization @relation(fields: [organization_id], references: [internal_id], onDelete: Cascade)

  @@map("organization_offboarding")
}

model Timesheet {
  internal_id Int     @id @default(autoincrement())
  id          String  @unique @default(dbgenerated("ulid_generate()"))
  employee_id String
  work_date   DateTime
  time_in     DateTime
  time_out    DateTime?
  total_hours Float
  source      String
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  employee Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@map("timesheets")
}

model LeaveRequest {
  internal_id Int     @id @default(autoincrement())
  id          String  @unique @default(dbgenerated("ulid_generate()"))
  employee_id String
  leave_type  String
  start_date  DateTime
  end_date    DateTime
  status      String   @default("PENDING")
  remarks     String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  employee Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@map("leave_requests")
}

model Payroll {
  internal_id  Int     @id @default(autoincrement())
  id           String  @unique @default(dbgenerated("ulid_generate()"))
  employee_id  String
  period_start DateTime
  period_end   DateTime
  gross_salary Float
  net_salary   Float
  processed_at DateTime @default(now())
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  employee   Employee    @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  deductions Deduction[]

  @@map("payrolls")
}

model Deduction {
  internal_id Int     @id @default(autoincrement())
  id          String  @unique @default(dbgenerated("ulid_generate()"))
  payroll_id  String
  type        String
  amount      Float
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  payroll Payroll @relation(fields: [payroll_id], references: [id], onDelete: Cascade)

  @@map("deductions")
}

model HolidayTemplate {
  internal_id     Int     @id @default(autoincrement())
  id              String  @unique @default(dbgenerated("ulid_generate()"))
  organization_id Int
  name            String
  description     String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  organization Organization @relation(fields: [organization_id], references: [internal_id], onDelete: Cascade)
  holidays     Holiday[]

  @@map("holiday_templates")
}

model Holiday {
  internal_id         Int     @id @default(autoincrement())
  id                  String  @unique @default(dbgenerated("ulid_generate()"))
  organization_id     Int
  holiday_template_id String
  date                DateTime
  is_recurring        Boolean  @default(false)
  type                String
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  holidayTemplate            HolidayTemplate             @relation(fields: [holiday_template_id], references: [id], onDelete: Cascade)
  calendarHolidays           CalendarHoliday[]
  employeeHolidayAssignments EmployeeHolidayAssignment[]

  @@map("holidays")
}

model EmployeeHolidayAssignment {
  internal_id Int     @id @default(autoincrement())
  id          String  @unique @default(dbgenerated("ulid_generate()"))
  employee_id String
  holiday_id  String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  employee Employee @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  holiday  Holiday  @relation(fields: [holiday_id], references: [id], onDelete: Cascade)

  @@unique([employee_id, holiday_id])
  @@map("employee_holiday_assignments")
}

model Calendar {
  internal_id     Int     @id @default(autoincrement())
  id              String  @unique @default(dbgenerated("ulid_generate()"))
  organization_id Int
  name            String
  description     String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  organization     Organization      @relation(fields: [organization_id], references: [internal_id], onDelete: Cascade)
  calendarHolidays CalendarHoliday[]

  @@map("calendars")
}

model CalendarHoliday {
  internal_id Int     @id @default(autoincrement())
  id          String  @unique @default(dbgenerated("ulid_generate()"))
  calendar_id String
  holiday_id  String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  calendar Calendar @relation(fields: [calendar_id], references: [id], onDelete: Cascade)
  holiday  Holiday  @relation(fields: [holiday_id], references: [id], onDelete: Cascade)

  @@unique([calendar_id, holiday_id])
  @@map("calendar_holidays")
}

// Better Auth required tables
model Account {
  internal_id       Int     @id @default(autoincrement())
  id                String  @unique @default(dbgenerated("ulid_generate()"))
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  internal_id  Int     @id @default(autoincrement())
  id           String  @unique @default(dbgenerated("ulid_generate()"))
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  internal_id Int     @id @default(autoincrement())
  id          String  @unique @default(dbgenerated("ulid_generate()"))
  identifier  String
  token       String   @unique
  expires     DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}
