generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/////////////////////////////
// ORGANIZATION & USERS
/////////////////////////////

model Organization {
  id            String             @id
  name          String
  email         String?
  contactNumber String?            @map("contact_number")
  address       String?
  logo          String?
  website       String?
  description   String?
  status        OrganizationStatus @default(ACTIVE)
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")

  users                   User[]
  employees               Employee[]
  calendars               Calendar[]
  payrollRules            PayrollRule[]
  holidayTemplates        HolidayTemplate[]
  holidays                Holiday[]
  departments             Department[]
  jobTitles               JobTitle[]
  payrollPeriods          PayrollPeriod[]
  compensations           Compensation[]
  timeEntries             TimeEntry[]
  leaveRequests           LeaveRequest[]
  overtimes               Overtime[]
  deductions              Deduction[]
  benefits                Benefit[]
  documents               Document[]
  admins                  Admin[]
  auditLogs               AuditLog[]
  roles                   Role[]
  permissions             Permission[]
  organizationOnboarding  OrganizationOnboarding?
  organizationOffboarding OrganizationOffboarding?
  taxBrackets             TaxBracket[]
  philhealthContributions PhilhealthContribution[]
  sssContributions        SSSContribution[]
  pagibigContributions    PagibigContribution[]
  employeeGovernmentInfos EmployeeGovernmentInfo[]
  TimeBreak               TimeBreak[]
  PayrollEarning          PayrollEarning[]

  @@index([status])
  @@map("organizations")
}

model User {
  id             String     @id
  email          String     @unique
  passwordHash   String?    @map("password_hash")
  status         UserStatus @default(ACTIVE)
  organizationId String     @map("organization_id")
  employeeId     String     @map("employee_id")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  sessions          Session[]
  accounts          Account[]
  auditLogs         AuditLog[]
  userRoles         UserRole[]
  passwordResetLogs UserPasswordResetLog[]

  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  Overtime  Overtime[]

  @@map("users")
}

/////////////////////////////
// EMPLOYEE & CALENDAR
/////////////////////////////

model Employee {
  id             String  @id
  organizationId String  @map("organization_id")
  departmentId   String? @map("department_id")
  jobTitleId     String? @map("job_title_id")
  calendarId     String? @map("calendar_id")
  employeeId     String? @map("employee_id")

  employmentStatus EmploymentStatus @default(ACTIVE) @map("employment_status")

  firstName String    @map("first_name")
  lastName  String    @map("last_name")
  email     String
  hireDate  DateTime  @map("hire_date")
  exitDate  DateTime? @map("exit_date")

  managerId     String?    @map("manager_id")
  manager       Employee?  @relation("EmployeeReportsTo", fields: [managerId], references: [id])
  directReports Employee[] @relation("EmployeeReportsTo")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department   Department?  @relation(fields: [departmentId], references: [id])
  jobTitle     JobTitle?    @relation(fields: [jobTitleId], references: [id])
  calendar     Calendar?    @relation(fields: [calendarId], references: [id])

  timeEntries         TimeEntry[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User[]

  compensations    Compensation[]
  leaveRequests    LeaveRequest[]
  payrolls         Payroll[]
  employeeBenefits EmployeeBenefit[]
  employeeDocument EmployeeDocument[]
  overtimes        Overtime[]
  governmentInfo   EmployeeGovernmentInfo?
  TimeBreak        TimeBreak[]
  PayrollEarning   PayrollEarning[]
  Deduction        Deduction[]

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([departmentId])
  @@index([jobTitleId])
  @@map("employees")
}

model Department {
  id             String  @id
  organizationId String  @map("organization_id")
  name           String
  description    String?

  organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employees     Employee[]
  compensations Compensation[]

  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  TimeEntry         TimeEntry[]
  LeaveRequest      LeaveRequest[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("departments")
}

model JobTitle {
  id             String  @id
  organizationId String  @map("organization_id")
  name           String
  description    String?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employees    Employee[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("job_titles")
}

model Calendar {
  id             String    @id
  organizationId String    @map("organization_id")
  name           String
  description    String?
  effectiveFrom  DateTime  @map("effective_from")
  effectiveTo    DateTime? @map("effective_to")

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  holidays     CalendarHoliday[]
  employees    Employee[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@map("calendars")
}

model CalendarHoliday {
  id         String @id
  calendarId String @map("calendar_id")
  holidayId  String @map("holiday_id")

  calendar Calendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)
  holiday  Holiday  @relation(fields: [holidayId], references: [id], onDelete: Cascade)

  @@unique([calendarId, holidayId])
  @@map("calendar_holidays")
}

/////////////////////////////
// HOLIDAYS
/////////////////////////////

model HolidayTemplate {
  id             String  @id
  organizationId String  @map("organization_id")
  name           String
  description    String?
  isDefault      Boolean @default(false) @map("is_default")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  holidays     Holiday[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("holiday_templates")
}

model Holiday {
  id                String      @id
  organizationId    String      @map("organization_id")
  holidayTemplateId String      @map("holiday_template_id")
  date              DateTime
  isRecurring       Boolean     @default(false) @map("is_recurring")
  type              HolidayType
  name              String
  isPaidIfNotWorked Boolean     @map("is_paid_if_not_worked")
  countsTowardOt    Boolean     @map("counts_toward_ot")
  rateMultiplier    Float       @map("rate_multiplier")

  organization      Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  holidayTemplate   HolidayTemplate             @relation(fields: [holidayTemplateId], references: [id], onDelete: Cascade)
  calendarLinks     CalendarHoliday[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([date])
  @@index([type])
  @@map("holidays")
}


/////////////////////////////
// PAYROLL RULES
/////////////////////////////

model PayrollRule {
  id             String       @id
  organizationId String       @map("organization_id")
  ruleCode       String       @map("rule_code")
  dayType        DayType      @map("day_type")
  holidayType    HolidayType? @map("holiday_type")
  appliesTo      PayComponent @map("applies_to")
  multiplier     Float
  effectiveFrom  DateTime     @map("effective_from")
  effectiveTo    DateTime?    @map("effective_to")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, ruleCode, effectiveFrom])
  @@map("payroll_rules")
}

/////////////////////////////
// TIME & PAYROLL
/////////////////////////////

model TimeEntry {
  id             String  @id
  employeeId     String  @map("employee_id")
  organizationId String  @map("organization_id")
  departmentId   String? @map("department_id")

  clockInAt  DateTime  @map("clock_in_at") @db.Timestamptz(3)
  clockOutAt DateTime? @map("clock_out_at") @db.Timestamptz(3)

  workDate         DateTime @map("work_date") @db.Date
  totalWorkMinutes Int?     @map("total_work_minutes")

  status TimeEntryStatus @default(OPEN)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  employee            Employee            @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  organization        Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department          Department?         @relation(fields: [departmentId], references: [id])
  timeBreaks          TimeBreak[]

  @@unique([employeeId, workDate])
  @@index([organizationId])
  @@index([employeeId])
  @@index([departmentId])
  @@index([workDate])
  @@index([status])
  @@map("time_entries")
}

model TimeBreak {
  id              String   @id
  timeEntryId     String   @map("time_entry_id")
  organizationId  String   @map("organization_id")
  employeeId      String   @map("employee_id")
  breakType       BreakType // MEAL, REST, etc
  breakStartAt    DateTime @map("break_start_at") @db.Timestamptz(3)
  breakEndAt      DateTime @map("break_end_at") @db.Timestamptz(3)
  isPaid          Boolean  @default(true)
  durationMinutes Int?     @map("duration_minutes")

  timeEntry    TimeEntry    @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([employeeId])
  @@index([timeEntryId])
  @@map("time_breaks")
}

model Payroll {
  id                  String   @id
  employeeId          String   @map("employee_id")
  organizationId      String   @map("organization_id")
  departmentId        String?  @map("department_id")
  periodStart         DateTime @map("period_start")
  periodEnd           DateTime @map("period_end")
  grossPay            Float    @map("gross_pay")
  netPay              Float    @map("net_pay")
  taxableIncome       Float?   @map("taxable_income")
  taxDeduction        Float?   @map("tax_deduction")
  philhealthDeduction Float?   @map("philhealth_deduction")
  sssDeduction        Float?   @map("sss_deduction")
  pagibigDeduction    Float?   @map("pagibig_deduction")
  totalDeductions     Float?   @map("total_deductions")
  processedAt         DateTime @default(now()) @map("processed_at")

  employee      Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  earnings      PayrollEarning[]
  deductions    Deduction[]
  payrollPeriod PayrollPeriod    @relation(fields: [periodStart, periodEnd], references: [startDate, endDate])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@index([employeeId])
  @@index([departmentId])
  @@index([periodStart, periodEnd])
  @@map("payrolls")
}

model PayrollPeriod {
  startDate      DateTime @map("start_date")
  endDate        DateTime @map("end_date")
  organizationId String   @map("organization_id")
  payDate        DateTime @map("pay_date")
  status         String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, CANCELLED
  type           String   @default("MONTHLY") // MONTHLY, SEMI_MONTHLY, BI_WEEKLY, WEEKLY
  year           Int
  month          Int?
  periodNumber   Int?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  payrolls     Payroll[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@id([organizationId, startDate, endDate])
  @@unique([startDate, endDate])
  @@index([organizationId])
  @@index([year])
  @@index([status])
  @@map("payroll_periods")
}

model PayrollEarning {
  id             String             @id
  payrollId      String             @map("payroll_id")
  organizationId String             @map("organization_id")
  employeeId     String             @map("employee_id")
  type           PayrollEarningType
  hours          Float
  rate           Float
  amount         Float

  payroll      Payroll      @relation(fields: [payrollId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([employeeId])
  @@index([payrollId])
  @@index([type])
  @@map("payroll_earnings")
}

model Deduction {
  id             String @id
  payrollId      String @map("payroll_id")
  organizationId String @map("organization_id")
  employeeId     String @map("employee_id")
  type           String
  amount         Float

  payroll      Payroll      @relation(fields: [payrollId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@index([employeeId])
  @@index([payrollId])
  @@index([type])
  @@map("deductions")
}

model LateDeductionPolicy {
  id             String         @id
  organizationId String         @map("organization_id")
  name           String // e.g., "Tardiness Policy", "Undertime Policy"
  policyType     LatePolicyType @map("policy_type") // LATE, UNDERTIME

  // Deduction method
  deductionMethod DeductionMethod @map("deduction_method") // FIXED_AMOUNT, PERCENTAGE, HOURLY_RATE

  // For FIXED_AMOUNT: Fixed amount per incident
  fixedAmount Float? @map("fixed_amount")

  // For PERCENTAGE: Percentage of daily rate
  percentageRate Float? @map("percentage_rate")

  // For HOURLY_RATE: Deduction based on hourly rate
  hourlyRateMultiplier Float? @map("hourly_rate_multiplier") // e.g., 0.5 for half hourly rate

  // Threshold settings
  gracePeriodMinutes Int @default(0) @map("grace_period_minutes") // Grace period before considering late
  minimumLateMinutes Int @default(1) @map("minimum_late_minutes") // Minimum minutes to be considered late

  // Maximum deduction per day/cutoff
  maxDeductionPerDay    Float? @map("max_deduction_per_day")
  maxDeductionPerCutoff Float? @map("max_deduction_per_cutoff")

  // Is this policy active?
  isActive Boolean @default(true) @map("is_active")

  // Policy effective dates
  effectiveDate DateTime  @map("effective_date")
  endDate       DateTime? @map("end_date")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@index([policyType])
  @@index([isActive])
  @@map("late_deduction_policies")
}

/////////////////////////////
// COMPENSATION & BENEFITS
/////////////////////////////

model Compensation {
  id             String         @id
  employeeId     String         @map("employee_id")
  organizationId String         @map("organization_id")
  departmentId   String?        @map("department_id")
  baseSalary     Float          @map("base_salary")
  hourlyRate     Float?         @map("hourly_rate") // For hourly employees
  employmentType EmploymentType @map("employment_type") // MONTHLY_SALARY, HOURLY, DAILY_WAGE
  payFrequency   PayFrequency   @map("pay_frequency")
  effectiveDate  DateTime       @map("effective_date")
  endDate        DateTime?      @map("end_date") // For tracking compensation history

  employee     Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department   Department?   @relation(fields: [departmentId], references: [id])
  workSchedule WorkSchedule? // One-to-one relationship

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@index([employeeId])
  @@index([departmentId])
  @@index([effectiveDate])
  @@map("compensations")
}

model WorkSchedule {
  id             String @id
  compensationId String @unique @map("compensation_id")
  organizationId String @map("organization_id")

  // Schedule type
  scheduleType ScheduleType @default(FIXED) @map("schedule_type") // FIXED, FLEXIBLE, ROTATING, HYBRID

  // Basic schedule configuration
  defaultStart String? @map("default_start") // HH:MM format (e.g., "09:00")
  defaultEnd   String? @map("default_end") // HH:MM format (e.g., "18:00")

  // Work days and rest days (PH Labor Code requirement)
  workDays String[] @default(["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY"]) @map("work_days")
  restDays String[] @default(["SATURDAY", "SUNDAY"]) @map("rest_days") // Legal rest days

  // Philippine-specific rates (Labor Code mandates)
  overtimeRate       Float @default(1.25) @map("overtime_rate") // 125% for OT (excess of 8h)
  restDayRate        Float @default(1.30) @map("rest_day_rate") // 130% for rest day work
  holidayRate        Float @default(1.30) @map("holiday_rate") // 130% for regular holiday
  specialHolidayRate Float @default(1.30) @map("special_holiday_rate") // 130% for special holiday
  doubleHolidayRate  Float @default(2.00) @map("double_holiday_rate") // 200% for work on regular holiday

  // Night differential (10PM - 6AM per DOLE)
  nightShiftStart String @default("22:00") @map("night_shift_start") // 10:00 PM
  nightShiftEnd   String @default("06:00") @map("night_shift_end") // 6:00 AM
  nightDiffRate   Float  @default(0.10) @map("night_diff_rate") // 10% of basic hourly rate

  // For ROTATING schedules (common in PH BPO)
  rotationPattern String?   @map("rotation_pattern") // e.g., "2D2N", "3-2-2"
  rotationStart   DateTime? @map("rotation_start") // When rotation starts
  shiftGroups     String[]  @map("shift_groups") // Morning, Evening, Night groups

  // For HYBRID schedules (post-pandemic trend)
  officeDays String[] @map("office_days") // Which days are office days
  remoteDays String[] @map("remote_days") // Which days are remote days

  // For FLEXIBLE schedules
  coreHoursStart    String? @map("core_hours_start") // Must be online during these hours
  coreHoursEnd      String? @map("core_hours_end")
  totalHoursPerWeek Float?  @map("total_hours_per_week") // Total required hours per week

  // Daily rate computation (PH requirement for wage deductions)
  isMonthlyRate Boolean @default(true) @map("is_monthly_rate")
  monthlyRate   Float?  @map("monthly_rate") // Monthly salary for daily rate calc
  dailyRate     Float?  @map("daily_rate") // Computed: Monthly ร 12 รท 313
  hourlyRate    Float?  @map("hourly_rate") // Computed: Daily รท 8

  // Grace period and required hours
  gracePeriodMinutes  Int @default(0) @map("grace_period_minutes")
  requiredWorkMinutes Int @default(480) @map("required_work_minutes") // 8 hours per PH Labor Code

  // Maximum hours (PH limit: 8 hours regular, +2 for certain industries)
  maxRegularHours  Int @default(8) @map("max_regular_hours")
  maxOvertimeHours Int @default(3) @map("max_overtime_hours") // Max 3 hours OT per day

  // Late deduction settings (PH allows but with limits)
  allowLateDeduction   Boolean @default(false) @map("allow_late_deduction")
  maxDeductionPerDay   Float?  @map("max_deduction_per_day") // Cannot exceed daily wage
  maxDeductionPerMonth Float?  @map("max_deduction_per_month") // Additional PH protection

  // Flexible settings
  isFlexibleSchedule Boolean @default(false) @map("is_flexible_schedule")
  minHoursPerDay     Float?  @map("min_hours_per_day")
  maxHoursPerDay     Float?  @map("max_hours_per_day")
  canLogAnyHours     Boolean @default(false) @map("can_log_any_hours")

  compensation Compensation @relation(fields: [compensationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@map("work_schedules")
}

model Benefit {
  id             String  @id
  organizationId String  @map("organization_id")
  name           String
  description    String?
  type           String

  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employeeBenefits EmployeeBenefit[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@index([type])
  @@map("benefits")
}

model EmployeeBenefit {
  id             String @id
  employeeId     String @map("employee_id")
  benefitId      String @map("benefit_id")
  organizationId String @map("organization_id")
  contribution   Float

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  benefit  Benefit  @relation(fields: [benefitId], references: [id], onDelete: Cascade)

  enrolledAt DateTime @default(now()) @map("enrolled_at")

  @@index([organizationId])
  @@index([employeeId])
  @@index([benefitId])
  @@map("employee_benefits")
}

/////////////////////////////
// DOCUMENTS & LEAVE
/////////////////////////////

model Document {
  id                String  @id
  organizationId    String  @map("organization_id")
  name              String
  fileType          String  @map("file_type")
  storagePath       String  @map("storage_path")
  requiresSignature Boolean @default(false) @map("requires_signature")

  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employeeDocuments EmployeeDocument[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  @@index([organizationId])
  @@index([fileType])
  @@index([name])
  @@map("documents")
}

model EmployeeDocument {
  id             String @id
  employeeId     String @map("employee_id")
  documentId     String @map("document_id")
  organizationId String @map("organization_id")
  version        String

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  uploadedAt DateTime  @default(now()) @map("uploaded_at")
  signedAt   DateTime? @map("signed_at")

  @@index([organizationId])
  @@index([employeeId])
  @@index([documentId])
  @@index([uploadedAt])
  @@map("employee_documents")
}

model LeaveRequest {
  id             String      @id
  employeeId     String      @map("employee_id")
  organizationId String      @map("organization_id")
  departmentId   String?     @map("department_id")
  leaveType      LeaveType   @map("leave_type")
  startDate      DateTime    @map("start_date")
  endDate        DateTime    @map("end_date")
  totalMinutes   Int?        @map("total_minutes")
  isPaid         Boolean     @default(true) @map("is_paid")
  status         LeaveStatus @default(PENDING)
  remarks        String?

  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department   Department?  @relation(fields: [departmentId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@index([employeeId])
  @@index([departmentId])
  @@index([status])
  @@index([leaveType])
  @@index([startDate, endDate])
  @@map("leave_requests")
}

/////////////////////////////
// ADMIN & AUDIT
/////////////////////////////

model Admin {
  id             String @id
  organizationId String @map("organization_id")
  name           String
  email          String
  role           String

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@index([email])
  @@index([role])
  @@map("admins")
}

model AuditLog {
  id             Int      @id @default(autoincrement())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  actionType     String   @map("action_type")
  entityType     String   @map("entity_type")
  entityId       String?  @map("entity_id")
  oldData        Json?    @map("old_data")
  newData        Json?    @map("new_data")
  timestamp      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@index([entityType])
  @@index([timestamp])
  @@map("audit_logs")
}

/////////////////////////////
// AUTH
/////////////////////////////

model Session {
  id           String   @id
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([expires])
  @@map("sessions")
}

model Account {
  id                String @id
  userId            String @map("user_id")
  provider          String
  providerAccountId String @map("provider_account_id")

  accessToken  String? @map("access_token")
  refreshToken String? @map("refresh_token")
  expiresAt    Int?    @map("expires_at")
  tokenType    String? @map("token_type")
  scope        String?
  idToken      String? @map("id_token")
  sessionState String? @map("session_state")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

/////////////////////////////
// RBAC
/////////////////////////////

model Role {
  id             String @id
  organizationId String @map("organization_id")
  name           String

  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("roles")
}

model Permission {
  description    String?
  id             String  @id
  organizationId String  @map("organization_id")
  name           String

  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  rolePermissions RolePermission[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@map("permissions")
}

model UserRole {
  id     String @id
  userId String @map("user_id")
  roleId String @map("role_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String @id
  roleId       String @map("role_id")
  permissionId String @map("permission_id")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

/////////////////////////////
// PASSWORD RESET
/////////////////////////////

model UserPasswordResetLog {
  id        String    @id
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@map("user_password_reset_logs")
}

/////////////////////////////
// OVERTIME
/////////////////////////////

model Overtime {
  id             String   @id
  employeeId     String   @map("employee_id")
  organizationId String   @map("organization_id")
  workDate       DateTime @map("work_date")

  timeEntryId String? @map("time_entry_id")
  timeStart   String? @map("time_start")
  timeEnd     String? @map("time_end")

  otType OvertimeType @map("ot_type")

  requestedMinutes Int                   @map("requested_minutes")
  approvedMinutes  Int?                  @map("approved_minutes")
  status           OvertimeRequestStatus @default(PENDING)
  reason           String
  remarks          String?               @map("remarks")
  approvedByUserId String?               @map("approved_by_user_id")
  approvedAt       DateTime?             @map("approved_at")

  employee       Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  approvedByUser User?        @relation(fields: [approvedByUserId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@index([employeeId])
  @@index([status])
  @@index([workDate])
  @@map("overtimes")
}

/////////////////////////////
// GOVERNMENT CONTRIBUTIONS
/////////////////////////////

model TaxBracket {
  id             String    @id
  organizationId String    @map("organization_id")
  minSalary      Float     @map("min_salary")
  maxSalary      Float?    @map("max_salary") // null for highest bracket
  baseTax        Float     @map("base_tax")
  rate           Float // percentage as decimal (0.20 for 20%)
  effectiveFrom  DateTime  @map("effective_from")
  effectiveTo    DateTime? @map("effective_to")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@index([effectiveFrom])
  @@map("tax_brackets")
}

model PhilhealthContribution {
  id             String    @id
  organizationId String    @map("organization_id")
  minSalary      Float     @map("min_salary")
  maxSalary      Float?    @map("max_salary") // null for highest bracket
  employeeRate   Float     @map("employee_rate") // percentage as decimal
  employerRate   Float     @map("employer_rate") // percentage as decimal
  effectiveFrom  DateTime  @map("effective_from")
  effectiveTo    DateTime? @map("effective_to")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@index([effectiveFrom])
  @@map("philhealth_contributions")
}

model SSSContribution {
  id             String    @id
  organizationId String    @map("organization_id")
  minSalary      Float     @map("min_salary")
  maxSalary      Float?    @map("max_salary") // null for highest bracket
  employeeRate   Float     @map("employee_rate") // percentage as decimal
  employerRate   Float     @map("employer_rate") // percentage as decimal
  ecRate         Float     @map("ec_rate") // Employees' Compensation rate
  effectiveFrom  DateTime  @map("effective_from")
  effectiveTo    DateTime? @map("effective_to")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@index([effectiveFrom])
  @@map("sss_contributions")
}

model PagibigContribution {
  id             String    @id
  organizationId String    @map("organization_id")
  minSalary      Float     @map("min_salary")
  maxSalary      Float?    @map("max_salary") // null for highest bracket
  employeeRate   Float     @map("employee_rate") // percentage as decimal
  employerRate   Float     @map("employer_rate") // percentage as decimal
  effectiveFrom  DateTime  @map("effective_from")
  effectiveTo    DateTime? @map("effective_to")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@index([effectiveFrom])
  @@map("pagibig_contributions")
}

model EmployeeGovernmentInfo {
  id             String @id
  employeeId     String @unique @map("employee_id")
  organizationId String @map("organization_id")

  sssNumber        String? @map("sss_number")
  philhealthNumber String? @map("philhealth_number")
  pagibigNumber    String? @map("pagibig_number")
  tinNumber        String? @map("tin_number")

  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@map("employee_government_info")
}

/////////////////////////////
// ORG LIFECYCLE
/////////////////////////////

model OrganizationOnboarding {
  id             String    @id
  organizationId String    @unique @map("organization_id")
  startedAt      DateTime  @default(now()) @map("started_at")
  completedAt    DateTime? @map("completed_at")
  status         String    @default("PENDING")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@map("organization_onboardings")
}

model OrganizationOffboarding {
  id             String    @id
  organizationId String    @unique @map("organization_id")
  startedAt      DateTime  @default(now()) @map("started_at")
  completedAt    DateTime? @map("completed_at")
  reason         String?
  status         String    @default("PENDING")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@map("organization_offboardings")
}

/////////////////////////////
// ENUMS
/////////////////////////////

enum DayType {
  REGULAR
  REST
  HOLIDAY
}

enum HolidayType {
  REGULAR
  SPECIAL_NON_WORKING
  SPECIAL_WORKING
  COMPANY
  LGU
}

enum PayComponent {
  REGULAR
  OVERTIME
  NIGHT_DIFF
}

enum PayrollEarningType {
  BASE_SALARY
  OVERTIME
  NIGHT_DIFFERENTIAL
  HOLIDAY_PAY
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  CLOSED
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum PayFrequency {
  MONTHLY
  SEMI_MONTHLY
  BI_WEEKLY
  WEEKLY
}

enum EmploymentType {
  MONTHLY_SALARY
  HOURLY
  DAILY_WAGE
}

enum ScheduleType {
  FIXED // Fixed 9-5 schedule
  FLEXIBLE // Flexible hours with core time
  ROTATING // Shift rotation
  HYBRID // Mix of office and remote
  COMPRESSED // 4-day work week, longer hours
  CUSTOM // Fully custom configuration
}

enum LatePolicyType {
  LATE
  UNDERTIME
}

enum DeductionMethod {
  FIXED_AMOUNT
  PERCENTAGE
  HOURLY_RATE
}

enum EmploymentStatus {
  ACTIVE
  RESIGNED
  TERMINATED
  RETIRED
}

enum LeaveType {
  VACATION
  SICK
  EMERGENCY
  BEREAVEMENT
  UNPAID
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum OrganizationOnboardingStatus {
  PENDING // record created, no action yet
  IN_PROGRESS // configuration/setup ongoing
  ON_HOLD // blocked (missing docs, payment, verification)
  COMPLETED // onboarding finished successfully
  CANCELLED // onboarding abandoned by org or system
}

enum TimeEntryStatus {
  OPEN
  CLOSED
}

enum BreakType {
  MEAL
  REST
  PERSONAL
  SYSTEM
}

enum OvertimeRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum OvertimeType {
  REGULAR_DAY
  REST_DAY
  EMERGENCY
  SPECIAL_HOLIDAY
  REGULAR_HOLIDAY
}
